@page "/chats/{roomId}"

@layout AppLayout

<TopBar Page="Chat" OnToggleVoiceMode=ToggleVoiceMode Room="Room" />

<main>
    <div class="message-list">
        @foreach (var msg in messages)
        {
            <div class="message-container @(IsUserMessage(msg.Sender) ? "my-message" : "")">
                <MessageCard Message=@msg IsMine=IsUserMessage(msg.Sender) />
            </div>
        }
    </div>
</main>

<ChatBar OnSendMessage=SendMessage VoiceMode=@voiceMode MessageSent=messageSent />

@inject ISparcAura Aura

@code {
    [Parameter] public required string RoomId { get; set; }

    BlossomUser? User { get; set; }
    List<MatrixEvent<MatrixMessage>> messages = [];
    MatrixRoomSummary? Room { get; set; }
    string? Since;

    PeriodicTimer? EverySecondPoller;

    bool voiceMode = false;
    bool messageSent = false;

    protected async override Task OnInitializedAsync()
    {
        User = await Aura.UserInfo();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(RoomId))
        {
            Room = await Chats.GetRoomSummaryAsync(RoomId);
            await SyncAsync();
        }
    }

    private async Task SyncAsync()
    {
        var sync = await Chats.SyncAsync(Since);
        messages.AddRange(sync.Rooms.Join[RoomId].Timeline.Events.OfType<MatrixEvent<MatrixMessage>>());
    }

    private async Task SendMessage(string messageText)
    {
        if (!string.IsNullOrWhiteSpace(messageText))
        {
            var txnId = Guid.NewGuid().ToString();
            await Chats.SendMessageAsync(Room!.RoomId, "m.room.message", txnId, new(messageText));

            // currentMessage = "";
            await SyncAsync();
            messageSent = true;
        }
    }

    void ToggleVoiceMode(bool voiceBool)
    {
        voiceMode = voiceBool;
    }

    private bool IsUserMessage(string userId)
    {
        var matrixId = User?.Identities?.FirstOrDefault(x => x.Type == "Matrix")?.Id;
        if (userId == matrixId)
        {
            return true;
        }
        else
        {
            return false;
        }
    }
}